<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="blog/layout">
<head>
    <meta charset="UTF-8"/>
    <title>首页</title>
</head>
<body>
<div layout:fragment="content">
    <div class="content-wrap">
        <div id="content" class="content">
            <div id="posts" class="posts-expand">
                <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
                    <div class="post-block" style="opacity: 1; display: block;">
                        <link itemprop="mainEntityOfPage"
                              href="http://yoursite.com/2018/07/07/what-happen-when-django-runserver/">
                        <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<meta itemprop="name" content="Cluas">
<meta itemprop="description" content="">
<meta itemprop="image" content="https://tvax3.sinaimg.cn/crop.0.0.888.888.180/98c33926ly8fsvm47o22bj20oo0oo0uo.jpg">
</span>
                        <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Cluas">
</span>
                        <header class="post-header" style="opacity: 1; display: block; transform: translateY(0px);">
                            <h1 class="post-title" itemprop="name headline">python manage.py runserver 的时候发生了什么？</h1>
                            <div class="post-meta">
<span class="post-time">
<span class="post-meta-item-icon">
<i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">发表于</span>
<time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-07T15:40:56+08:00">
2018-07-07
</time>
</span>
                                <span class="post-category">
<span class="post-meta-divider">|</span>
<span class="post-meta-item-icon">
<i class="fa fa-folder-o"></i>
</span>
<span class="post-meta-item-text">分类于</span>
<span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
<a href="/categories/django/" itemprop="url" rel="index">
<span itemprop="name">django</span>
</a>
</span>
</span>
                            </div>
                        </header>
                        <div class="post-body" itemprop="articleBody"
                             style="opacity: 1; display: block; transform: translateY(0px);">
                            <p>在我们日常用django开发的时候，runserver这个manage命令相信大家一定不陌生, 那么你是否有考虑过, 在命令行输入这个命令的时候到底发生了什么？<br>下面就请跟着我一步一步剖析django的源代码,
                                看看它到底做了什么…</p>
                            <h3 id="manage-py"><a href="#manage-py" class="headerlink" title="manage.py"></a>manage.py
                            </h3>
                            <p>经常用django开发的同学对这个文件一定不陌生, 它是我们运行django-admin startproject 的时候自动生成的. 在这边文章中，
                                我们不会去讨论django是怎么做到自动生成类似模版文件一样的项目代码的，我们关注的重点是运行 python manage.py runserver 后到底发生了什么.</p>
                            <h3 id="入口程序"><a href="#入口程序" class="headerlink" title="入口程序"></a>入口程序</h3>
                            <p>让我们打开我们的manage.py 文件， 你可能会看到以下内容（注：本文示例采用django2.0）：<br></p>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span
                                                class="comment">#!/usr/bin/env python</span></span><br><span
                                                class="line"><span class="keyword">import</span> os</span><br><span
                                                class="line"><span class="keyword">import</span> sys</span><br><span
                                                class="line"></span><br><span class="line"><span
                                                class="keyword">if</span> __name__ == <span
                                                class="string">"__main__"</span>:</span><br><span class="line">    os.environ.setdefault(<span
                                                class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"taskmaster.settings"</span>)</span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        <span class="keyword">from</span> django.core.management <span
                                                class="keyword">import</span> execute_from_command_line</span><br><span
                                                class="line">    <span class="keyword">except</span> ImportError <span
                                                class="keyword">as</span> exc:</span><br><span
                                                class="line">        <span
                                                class="keyword">raise</span> ImportError(</span><br><span class="line">            <span
                                                class="string">"Couldn't import Django. Are you sure it's installed and "</span></span><br><span
                                                class="line">            <span class="string">"available on your PYTHONPATH environment variable? Did you "</span></span><br><span
                                                class="line">            <span class="string">"forget to activate a virtual environment?"</span></span><br><span
                                                class="line">        ) <span
                                                class="keyword">from</span> exc</span><br><span class="line">    execute_from_command_line(sys.argv)</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p></p>
                            <p>程序运行的第一件事就是设置了一个环境变量， 指定了django项目的settings文件， 除去异常处理外， 就到了我们最关键的入口 <code>execute_from_command_line(sys.argv)</code><br>如果你常规的运行runserver命令不附带任何其他参数，
                                此时的sys.argv 应该是 <code>[manage.py文件绝对路径, 'runserver']</code>,
                                它被作为参数传入了execute_from_command_line这个函数。</p>
                            <h3 id="execute-from-command-line"><a href="#execute-from-command-line" class="headerlink"
                                                                  title="execute_from_command_line"></a>execute_from_command_line
                            </h3>
                            <p>下面就让我们看看这个函数到底干了啥。<br>它一共就两行代码- -</p>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">execute_from_command_line</span><span class="params">(argv=None)</span>:</span></span><br><span
                                                class="line">    <span
                                                class="string">"""Run a ManagementUtility."""</span></span><br><span
                                                class="line">    utility = ManagementUtility(argv)</span><br><span
                                                class="line">    utility.execute()</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p>这个函数只负责创建一个公共设施之类的东西， 它实例化了一个ManagementUtility对象， 它初始化了方法如下：<br></p>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">__init__</span><span
                                                class="params">(self, argv=None)</span>:</span></span><br><span
                                                class="line">    self.argv = argv <span class="keyword">or</span> sys.argv[:]</span><br><span
                                                class="line">    self.prog_name = os.path.basename(self.argv[<span
                                                class="number">0</span>])</span><br><span class="line">    <span
                                                class="keyword">if</span> self.prog_name == <span class="string">'__main__.py'</span>:</span><br><span
                                                class="line">        self.prog_name = <span class="string">'python -m django'</span>  <span
                                                class="comment"># 目前来说这么做的意义为何还不明朗， 希望有知道同学可以解答我的疑惑</span></span><br><span
                                                class="line">    self.settings_exception = <span
                                                class="keyword">None</span></span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p></p>
                            <p>实例化完成了， 它马上调用了它的execute()方法， 顾名思义， 执行方法。<br>看来我们今天要探索的主角就是它了</p>
                            <h3 id="execute"><a href="#execute" class="headerlink" title="execute()"></a>execute()</h3>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br><span class="line">18</span><br><span
                                                class="line">19</span><br><span class="line">20</span><br><span
                                                class="line">21</span><br><span class="line">22</span><br><span
                                                class="line">23</span><br><span class="line">24</span><br><span
                                                class="line">25</span><br><span class="line">26</span><br><span
                                                class="line">27</span><br><span class="line">28</span><br><span
                                                class="line">29</span><br><span class="line">30</span><br><span
                                                class="line">31</span><br><span class="line">32</span><br><span
                                                class="line">33</span><br><span class="line">34</span><br><span
                                                class="line">35</span><br><span class="line">36</span><br><span
                                                class="line">37</span><br><span class="line">38</span><br><span
                                                class="line">39</span><br><span class="line">40</span><br><span
                                                class="line">41</span><br><span class="line">42</span><br><span
                                                class="line">43</span><br><span class="line">44</span><br><span
                                                class="line">45</span><br><span class="line">46</span><br><span
                                                class="line">47</span><br><span class="line">48</span><br><span
                                                class="line">49</span><br><span class="line">50</span><br><span
                                                class="line">51</span><br><span class="line">52</span><br><span
                                                class="line">53</span><br><span class="line">54</span><br><span
                                                class="line">55</span><br><span class="line">56</span><br><span
                                                class="line">57</span><br><span class="line">58</span><br><span
                                                class="line">59</span><br><span class="line">60</span><br><span
                                                class="line">61</span><br><span class="line">62</span><br><span
                                                class="line">63</span><br><span class="line">64</span><br><span
                                                class="line">65</span><br><span class="line">66</span><br><span
                                                class="line">67</span><br><span class="line">68</span><br><span
                                                class="line">69</span><br><span class="line">70</span><br><span
                                                class="line">71</span><br><span class="line">72</span><br><span
                                                class="line">73</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">execute</span><span
                                                class="params">(self)</span>:</span></span><br><span
                                                class="line">    <span class="string">"""</span></span><br><span
                                                class="line"><span class="string">    Given the command-line arguments, figure out which subcommand is being</span></span><br><span
                                                class="line"><span class="string">    run, create a parser appropriate to that command, and run it.</span></span><br><span
                                                class="line"><span class="string">    """</span></span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        subcommand = self.argv[<span
                                                class="number">1</span>]</span><br><span class="line">    <span
                                                class="keyword">except</span> IndexError:</span><br><span class="line">        subcommand = <span
                                                class="string">'help'</span>  <span class="comment"># Display help if no arguments were given.</span></span><br><span
                                                class="line"></span><br><span class="line">    <span class="comment"># Preprocess options to extract --settings and --pythonpath.</span></span><br><span
                                                class="line">    <span class="comment"># These options could affect the commands that are available, so they</span></span><br><span
                                                class="line">    <span class="comment"># must be processed early.</span></span><br><span
                                                class="line">    parser = CommandParser(<span
                                                class="keyword">None</span>, usage=<span class="string">"%(prog)s subcommand [options] [args]"</span>, add_help=<span
                                                class="keyword">False</span>)</span><br><span class="line">    parser.add_argument(<span
                                                class="string">'--settings'</span>)</span><br><span class="line">    parser.add_argument(<span
                                                class="string">'--pythonpath'</span>)</span><br><span class="line">    parser.add_argument(<span
                                                class="string">'args'</span>, nargs=<span
                                                class="string">'*'</span>)  <span
                                                class="comment"># catch-all</span></span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        options, args = parser.parse_known_args(self.argv[<span
                                                class="number">2</span>:])</span><br><span class="line">        handle_default_options(options)</span><br><span
                                                class="line">    <span
                                                class="keyword">except</span> CommandError:</span><br><span
                                                class="line">        <span class="keyword">pass</span>  <span
                                                class="comment"># Ignore any option errors at this point.</span></span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">try</span>:</span><br><span class="line">        settings.INSTALLED_APPS</span><br><span
                                                class="line">    <span class="keyword">except</span> ImproperlyConfigured <span
                                                class="keyword">as</span> exc:</span><br><span class="line">        self.settings_exception = exc</span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">if</span> settings.configured:</span><br><span
                                                class="line">        <span class="comment"># Start the auto-reloading dev server even if the code is broken.</span></span><br><span
                                                class="line">        <span class="comment"># The hardcoded condition is a code smell but we can't rely on a</span></span><br><span
                                                class="line">        <span class="comment"># flag on the command class because we haven't located it yet.</span></span><br><span
                                                class="line">        <span class="keyword">if</span> subcommand == <span
                                                class="string">'runserver'</span> <span class="keyword">and</span> <span
                                                class="string">'--noreload'</span> <span
                                                class="keyword">not</span> <span
                                                class="keyword">in</span> self.argv:</span><br><span class="line">            <span
                                                class="keyword">try</span>:</span><br><span class="line">                autoreload.check_errors(django.setup)()</span><br><span
                                                class="line">            <span class="keyword">except</span> Exception:</span><br><span
                                                class="line">                <span class="comment"># The exception will be raised later in the child process</span></span><br><span
                                                class="line">                <span class="comment"># started by the autoreloader. Pretend it didn't happen by</span></span><br><span
                                                class="line">                <span class="comment"># loading an empty list of applications.</span></span><br><span
                                                class="line">                apps.all_models = defaultdict(OrderedDict)</span><br><span
                                                class="line">                apps.app_configs = OrderedDict()</span><br><span
                                                class="line">                apps.apps_ready = apps.models_ready = apps.ready = <span
                                                class="keyword">True</span></span><br><span
                                                class="line"></span><br><span class="line">                <span
                                                class="comment"># Remove options not compatible with the built-in runserver</span></span><br><span
                                                class="line">                <span class="comment"># (e.g. options for the contrib.staticfiles' runserver).</span></span><br><span
                                                class="line">                <span class="comment"># Changes here require manually testing as described in</span></span><br><span
                                                class="line">                <span
                                                class="comment"># #27522.</span></span><br><span class="line">                _parser = self.fetch_command(<span
                                                class="string">'runserver'</span>).create_parser(<span class="string">'django'</span>, <span
                                                class="string">'runserver'</span>)</span><br><span class="line">                _options, _args = _parser.parse_known_args(self.argv[<span
                                                class="number">2</span>:])</span><br><span class="line">                <span
                                                class="keyword">for</span> _arg <span
                                                class="keyword">in</span> _args:</span><br><span class="line">                    self.argv.remove(_arg)</span><br><span
                                                class="line"></span><br><span class="line">        <span
                                                class="comment"># In all other cases, django.setup() is required to succeed.</span></span><br><span
                                                class="line">        <span class="keyword">else</span>:</span><br><span
                                                class="line">            django.setup()</span><br><span
                                                class="line"></span><br><span
                                                class="line">    self.autocomplete()</span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">if</span> subcommand == <span
                                                class="string">'help'</span>:</span><br><span class="line">        <span
                                                class="keyword">if</span> <span class="string">'--commands'</span> <span
                                                class="keyword">in</span> args:</span><br><span class="line">            sys.stdout.write(self.main_help_text(commands_only=<span
                                                class="keyword">True</span>) + <span
                                                class="string">'\n'</span>)</span><br><span class="line">        <span
                                                class="keyword">elif</span> len(options.args) &lt; <span class="number">1</span>:</span><br><span
                                                class="line">            sys.stdout.write(self.main_help_text() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">        <span
                                                class="keyword">else</span>:</span><br><span class="line">            self.fetch_command(options.args[<span
                                                class="number">0</span>]).print_help(self.prog_name, options.args[<span
                                                class="number">0</span>])</span><br><span class="line">    <span
                                                class="comment"># Special-cases: We want 'django-admin --version' and</span></span><br><span
                                                class="line">    <span class="comment"># 'django-admin --help' to work, for backwards compatibility.</span></span><br><span
                                                class="line">    <span class="keyword">elif</span> subcommand == <span
                                                class="string">'version'</span> <span class="keyword">or</span> self.argv[<span
                                                class="number">1</span>:] == [<span class="string">'--version'</span>]:</span><br><span
                                                class="line">        sys.stdout.write(django.get_version() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">    <span
                                                class="keyword">elif</span> self.argv[<span
                                                class="number">1</span>:] <span class="keyword">in</span> ([<span
                                                class="string">'--help'</span>], [<span
                                                class="string">'-h'</span>]):</span><br><span class="line">        sys.stdout.write(self.main_help_text() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">    <span
                                                class="keyword">else</span>:</span><br><span class="line">        self.fetch_command(subcommand).run_from_argv(self.argv)</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p>有的同学一看到这， 心里马上冒出三个字: 打扰了..<br>这很正常， 我看到这么长的代码也有点慌， 生怕自己看不懂， 但是我们一定要知道一件事，
                                任何复杂的系统都是由一个个简单的组建组成的， <em>如果你还没有全局的概念就试图记忆细节，那么学习就会陷入僵局</em>。<br>不信你仔细看， 去掉英文注释，
                                代码量就那么一点点，
                                也是相对好理解的。让我们来尝试自己加注释， 一步步把它解释下来。<br></p>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br><span class="line">18</span><br><span
                                                class="line">19</span><br><span class="line">20</span><br><span
                                                class="line">21</span><br><span class="line">22</span><br><span
                                                class="line">23</span><br><span class="line">24</span><br><span
                                                class="line">25</span><br><span class="line">26</span><br><span
                                                class="line">27</span><br><span class="line">28</span><br><span
                                                class="line">29</span><br><span class="line">30</span><br><span
                                                class="line">31</span><br><span class="line">32</span><br><span
                                                class="line">33</span><br><span class="line">34</span><br><span
                                                class="line">35</span><br><span class="line">36</span><br><span
                                                class="line">37</span><br><span class="line">38</span><br><span
                                                class="line">39</span><br><span class="line">40</span><br><span
                                                class="line">41</span><br><span class="line">42</span><br><span
                                                class="line">43</span><br><span class="line">44</span><br><span
                                                class="line">45</span><br><span class="line">46</span><br><span
                                                class="line">47</span><br><span class="line">48</span><br><span
                                                class="line">49</span><br><span class="line">50</span><br><span
                                                class="line">51</span><br><span class="line">52</span><br><span
                                                class="line">53</span><br><span class="line">54</span><br><span
                                                class="line">55</span><br><span class="line">56</span><br><span
                                                class="line">57</span><br><span class="line">58</span><br><span
                                                class="line">59</span><br><span class="line">60</span><br><span
                                                class="line">61</span><br><span class="line">62</span><br><span
                                                class="line">63</span><br><span class="line">64</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">execute</span><span
                                                class="params">(self)</span>:</span></span><br><span
                                                class="line">    <span class="string">"""</span></span><br><span
                                                class="line"><span class="string">    给定命令行参数，找出正在使用的子命令，创建一个适合该命令的解析器，然后运行它。</span></span><br><span
                                                class="line"><span class="string">    """</span></span><br><span
                                                class="line">    <span
                                                class="comment"># 第一步, 找到子命令名称 本例子中是runserver</span></span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        subcommand = self.argv[<span
                                                class="number">1</span>]  <span class="comment"># subcommand: 'runserver' </span></span><br><span
                                                class="line">    <span
                                                class="keyword">except</span> IndexError:</span><br><span class="line">        subcommand = <span
                                                class="string">'help'</span>  <span class="comment"># 展示help选项， 如果没有指令传进来</span></span><br><span
                                                class="line"></span><br><span class="line">    <span class="comment"># 用于提取的预处理选项--settings和--pythonpath。这些选项可能会影响可用的命令，因此它们必须尽早处理。</span></span><br><span
                                                class="line">    parser = CommandParser(<span
                                                class="keyword">None</span>, usage=<span class="string">"%(prog)s subcommand [options] [args]"</span>, add_help=<span
                                                class="keyword">False</span>) <span class="comment"># CommandParser只是对argparse里ArgumentParser做了简单封装</span></span><br><span
                                                class="line">    parser.add_argument(<span
                                                class="string">'--settings'</span>)</span><br><span class="line">    parser.add_argument(<span
                                                class="string">'--pythonpath'</span>)</span><br><span class="line">    parser.add_argument(<span
                                                class="string">'args'</span>, nargs=<span
                                                class="string">'*'</span>)  <span
                                                class="comment"># 捕获剩余的其他参数</span></span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        options, args = parser.parse_known_args(self.argv[<span
                                                class="number">2</span>:])  <span class="comment"># 返回一个命名空间和其他参数， 你可能注意到了值得就是--settings和--pythonpath</span></span><br><span
                                                class="line">        handle_default_options(options)  <span
                                                class="comment"># 如果有这两项参数的</span></span><br><span
                                                class="line">    <span
                                                class="keyword">except</span> CommandError:</span><br><span
                                                class="line">        <span class="keyword">pass</span>  <span
                                                class="comment"># 忽略任何错误的设置</span></span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">try</span>:</span><br><span class="line">        settings.INSTALLED_APPS </span><br><span
                                                class="line">    <span class="keyword">except</span> ImproperlyConfigured <span
                                                class="keyword">as</span> exc:  <span class="comment"># 如果INSTALLED_APPS为空会抛出这个异常， 具体查看LazyObject的_setup()方法</span></span><br><span
                                                class="line">        self.settings_exception = exc</span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">if</span> settings.configured:</span><br><span
                                                class="line">        <span class="comment">#即使代码被破坏，也要启动自动重新加载开发服务器。硬编码的条件是代码味道不对，但我们不能依赖于在命令类上标记，因为我们还没有找到它</span></span><br><span
                                                class="line">        <span class="keyword">if</span> subcommand == <span
                                                class="string">'runserver'</span> <span class="keyword">and</span> <span
                                                class="string">'--noreload'</span> <span
                                                class="keyword">not</span> <span
                                                class="keyword">in</span> self.argv:</span><br><span class="line">            <span
                                                class="keyword">try</span>:</span><br><span class="line">                autoreload.check_errors(django.setup)()  <span
                                                class="comment"># 检查错误</span></span><br><span
                                                class="line">            <span class="keyword">except</span> Exception:</span><br><span
                                                class="line">                <span class="comment"># 稍后将在autoreloader启动的子进程中引发异常。通过加载空的应用程序列表假装它没有发生。</span></span><br><span
                                                class="line">                apps.all_models = defaultdict(OrderedDict)</span><br><span
                                                class="line">                apps.app_configs = OrderedDict()</span><br><span
                                                class="line">                apps.apps_ready = apps.models_ready = apps.ready = <span
                                                class="keyword">True</span></span><br><span
                                                class="line"></span><br><span class="line">                <span
                                                class="comment">#删除与内置runserver不兼容的选项, 例如contrib.staticfiles的runserver的选项。此处的更改需要手动测试</span></span><br><span
                                                class="line">                _parser = self.fetch_command(<span
                                                class="string">'runserver'</span>).create_parser(<span class="string">'django'</span>, <span
                                                class="string">'runserver'</span>)</span><br><span class="line">                _options, _args = _parser.parse_known_args(self.argv[<span
                                                class="number">2</span>:])</span><br><span class="line">                <span
                                                class="keyword">for</span> _arg <span
                                                class="keyword">in</span> _args:</span><br><span class="line">                    self.argv.remove(_arg)</span><br><span
                                                class="line"></span><br><span class="line">        <span
                                                class="comment"># 如果是其它选项，则单纯的setup()Django。</span></span><br><span
                                                class="line">        <span class="keyword">else</span>:</span><br><span
                                                class="line">            django.setup()</span><br><span
                                                class="line"></span><br><span
                                                class="line">    self.autocomplete()</span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">if</span> subcommand == <span
                                                class="string">'help'</span>:</span><br><span class="line">        <span
                                                class="keyword">if</span> <span class="string">'--commands'</span> <span
                                                class="keyword">in</span> args:</span><br><span class="line">            sys.stdout.write(self.main_help_text(commands_only=<span
                                                class="keyword">True</span>) + <span
                                                class="string">'\n'</span>)</span><br><span class="line">        <span
                                                class="keyword">elif</span> len(options.args) &lt; <span class="number">1</span>:</span><br><span
                                                class="line">            sys.stdout.write(self.main_help_text() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">        <span
                                                class="keyword">else</span>:</span><br><span class="line">            self.fetch_command(options.args[<span
                                                class="number">0</span>]).print_help(self.prog_name, options.args[<span
                                                class="number">0</span>])</span><br><span class="line">    <span
                                                class="comment"># 特殊例子：我们想要'django-admin --version'和'django-admin --help'能够被使用，以实现向后兼容。</span></span><br><span
                                                class="line">    <span class="keyword">elif</span> subcommand == <span
                                                class="string">'version'</span> <span class="keyword">or</span> self.argv[<span
                                                class="number">1</span>:] == [<span class="string">'--version'</span>]:</span><br><span
                                                class="line">        sys.stdout.write(django.get_version() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">    <span
                                                class="keyword">elif</span> self.argv[<span
                                                class="number">1</span>:] <span class="keyword">in</span> ([<span
                                                class="string">'--help'</span>], [<span
                                                class="string">'-h'</span>]):</span><br><span class="line">        sys.stdout.write(self.main_help_text() + <span
                                                class="string">'\n'</span>)</span><br><span class="line">    <span
                                                class="keyword">else</span>:</span><br><span class="line">        self.fetch_command(subcommand).run_from_argv(self.argv)</span><br><span
                                                class="line">        <span
                                                class="comment"># 最后在此调用了runserver的run方法</span></span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p></p>
                            <h3 id="run-from-argv"><a href="#run-from-argv" class="headerlink"
                                                      title="run_from_argv"></a>run_from_argv
                            </h3>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br><span class="line">18</span><br><span
                                                class="line">19</span><br><span class="line">20</span><br><span
                                                class="line">21</span><br><span class="line">22</span><br><span
                                                class="line">23</span><br><span class="line">24</span><br><span
                                                class="line">25</span><br><span class="line">26</span><br><span
                                                class="line">27</span><br><span class="line">28</span><br><span
                                                class="line">29</span><br><span class="line">30</span><br><span
                                                class="line">31</span><br><span class="line">32</span><br><span
                                                class="line">33</span><br><span class="line">34</span><br><span
                                                class="line">35</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">run_from_argv</span><span
                                                class="params">(self, argv)</span>:</span></span><br><span class="line">    <span
                                                class="string">"""</span></span><br><span class="line"><span
                                                class="string">    Set up any environment changes requested (e.g., Python path</span></span><br><span
                                                class="line"><span class="string">    and Django settings), then run this command. If the</span></span><br><span
                                                class="line"><span class="string">    command raises a ``CommandError``, intercept it and print it sensibly</span></span><br><span
                                                class="line"><span class="string">    to stderr. If the ``--traceback`` option is present or the raised</span></span><br><span
                                                class="line"><span class="string">    ``Exception`` is not ``CommandError``, raise it.</span></span><br><span
                                                class="line"><span class="string">    """</span></span><br><span
                                                class="line">    self._called_from_command_line = <span class="keyword">True</span></span><br><span
                                                class="line">    parser = self.create_parser(argv[<span
                                                class="number">0</span>], argv[<span
                                                class="number">1</span>])</span><br><span class="line"></span><br><span
                                                class="line">    options = parser.parse_args(argv[<span
                                                class="number">2</span>:])</span><br><span class="line">    cmd_options = vars(options)</span><br><span
                                                class="line">    <span class="comment"># Move positional args out of options to mimic legacy optparse</span></span><br><span
                                                class="line">    args = cmd_options.pop(<span
                                                class="string">'args'</span>, ())</span><br><span class="line">    handle_default_options(options)</span><br><span
                                                class="line">    <span class="keyword">try</span>:</span><br><span
                                                class="line">        self.execute(*args, **cmd_options) <span
                                                class="comment"># 又回到子命令的执行函数</span></span><br><span
                                                class="line">    <span class="keyword">except</span> Exception <span
                                                class="keyword">as</span> e:</span><br><span class="line">        <span
                                                class="keyword">if</span> options.traceback <span
                                                class="keyword">or</span> <span class="keyword">not</span> isinstance(e, CommandError):</span><br><span
                                                class="line">            <span
                                                class="keyword">raise</span></span><br><span
                                                class="line"></span><br><span class="line">        <span
                                                class="comment"># SystemCheckError takes care of its own formatting.</span></span><br><span
                                                class="line">        <span class="keyword">if</span> isinstance(e, SystemCheckError):</span><br><span
                                                class="line">            self.stderr.write(str(e), <span
                                                class="keyword">lambda</span> x: x)</span><br><span class="line">        <span
                                                class="keyword">else</span>:</span><br><span class="line">            self.stderr.write(<span
                                                class="string">'%s: %s'</span> % (e.__class__.__name__, e))</span><br><span
                                                class="line">        sys.exit(<span
                                                class="number">1</span>)</span><br><span class="line">    <span
                                                class="keyword">finally</span>:</span><br><span
                                                class="line">        <span class="keyword">try</span>:</span><br><span
                                                class="line">            connections.close_all()</span><br><span
                                                class="line">        <span class="keyword">except</span> ImproperlyConfigured:</span><br><span
                                                class="line">            <span class="comment"># Ignore if connections aren't setup at this point (e.g. no</span></span><br><span
                                                class="line">            <span
                                                class="comment"># configured settings).</span></span><br><span
                                                class="line">            <span
                                                class="keyword">pass</span></span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <h3 id="runserver-command-的-execute"><a href="#runserver-command-的-execute"
                                                                    class="headerlink"
                                                                    title="runserver command 的 execute"></a>runserver
                                command 的 execute</h3>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">execute</span><span class="params">(self, *args, **options)</span>:</span></span><br><span
                                                class="line">    <span class="keyword">if</span> options[<span
                                                class="string">'no_color'</span>]:</span><br><span class="line">        <span
                                                class="comment"># We rely on the environment because it's currently the only</span></span><br><span
                                                class="line">        <span class="comment"># way to reach WSGIRequestHandler. This seems an acceptable</span></span><br><span
                                                class="line">        <span class="comment"># compromise considering `runserver` runs indefinitely.</span></span><br><span
                                                class="line">        os.environ[<span
                                                class="string">"DJANGO_COLORS"</span>] = <span
                                                class="string">"nocolor"</span></span><br><span class="line">    super().execute(*args, **options)  <span
                                                class="comment"># 做了一层简单的判断 就调用了父类的execute</span></span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <h3 id="BaseCommand-execute"><a href="#BaseCommand-execute" class="headerlink"
                                                            title="BaseCommand execute"></a>BaseCommand execute</h3>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br><span class="line">18</span><br><span
                                                class="line">19</span><br><span class="line">20</span><br><span
                                                class="line">21</span><br><span class="line">22</span><br><span
                                                class="line">23</span><br><span class="line">24</span><br><span
                                                class="line">25</span><br><span class="line">26</span><br><span
                                                class="line">27</span><br><span class="line">28</span><br><span
                                                class="line">29</span><br><span class="line">30</span><br><span
                                                class="line">31</span><br><span class="line">32</span><br><span
                                                class="line">33</span><br><span class="line">34</span><br><span
                                                class="line">35</span><br><span class="line">36</span><br><span
                                                class="line">37</span><br><span class="line">38</span><br><span
                                                class="line">39</span><br><span class="line">40</span><br><span
                                                class="line">41</span><br><span class="line">42</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">execute</span><span class="params">(self, *args, **options)</span>:</span></span><br><span
                                                class="line">    <span class="string">"""</span></span><br><span
                                                class="line"><span class="string">    Try to execute this command, performing system checks if needed (as</span></span><br><span
                                                class="line"><span class="string">    controlled by the ``requires_system_checks`` attribute, except if</span></span><br><span
                                                class="line"><span
                                                class="string">    force-skipped).</span></span><br><span
                                                class="line"><span class="string">    """</span></span><br><span
                                                class="line">    <span class="keyword">if</span> options[<span
                                                class="string">'no_color'</span>]:</span><br><span class="line">        self.style = no_style()</span><br><span
                                                class="line">        self.stderr.style_func = <span
                                                class="keyword">None</span></span><br><span class="line">    <span
                                                class="keyword">if</span> options.get(<span
                                                class="string">'stdout'</span>):</span><br><span class="line">        self.stdout = OutputWrapper(options[<span
                                                class="string">'stdout'</span>])</span><br><span class="line">    <span
                                                class="keyword">if</span> options.get(<span
                                                class="string">'stderr'</span>):</span><br><span class="line">        self.stderr = OutputWrapper(options[<span
                                                class="string">'stderr'</span>], self.stderr.style_func)</span><br><span
                                                class="line"></span><br><span class="line">    saved_locale = <span
                                                class="keyword">None</span></span><br><span class="line">    <span
                                                class="keyword">if</span> <span class="keyword">not</span> self.leave_locale_alone:</span><br><span
                                                class="line">        <span class="comment"># Deactivate translations, because django-admin creates database</span></span><br><span
                                                class="line">        <span class="comment"># content like permissions, and those shouldn't contain any</span></span><br><span
                                                class="line">        <span class="comment"># translations.</span></span><br><span
                                                class="line">        <span
                                                class="keyword">from</span> django.utils <span
                                                class="keyword">import</span> translation</span><br><span class="line">        saved_locale = translation.get_language()</span><br><span
                                                class="line">        translation.deactivate_all()</span><br><span
                                                class="line"></span><br><span class="line">    <span
                                                class="keyword">try</span>:</span><br><span class="line">        <span
                                                class="keyword">if</span> self.requires_system_checks <span
                                                class="keyword">and</span> <span class="keyword">not</span> options.get(<span
                                                class="string">'skip_checks'</span>):</span><br><span class="line">            self.check()</span><br><span
                                                class="line">        <span class="keyword">if</span> self.requires_migrations_checks:</span><br><span
                                                class="line">            self.check_migrations()</span><br><span
                                                class="line">        output = self.handle(*args, **options) <span
                                                class="comment"># 这句是关键</span></span><br><span
                                                class="line">        <span
                                                class="keyword">if</span> output:</span><br><span class="line">            <span
                                                class="keyword">if</span> self.output_transaction:</span><br><span
                                                class="line">                connection = connections[options.get(<span
                                                class="string">'database'</span>, DEFAULT_DB_ALIAS)]</span><br><span
                                                class="line">                output = <span
                                                class="string">'%s\n%s\n%s'</span> % (</span><br><span class="line">                    self.style.SQL_KEYWORD(connection.ops.start_transaction_sql()),</span><br><span
                                                class="line">                    output,</span><br><span class="line">                    self.style.SQL_KEYWORD(connection.ops.end_transaction_sql()),</span><br><span
                                                class="line">                )</span><br><span class="line">            self.stdout.write(output)</span><br><span
                                                class="line">    <span class="keyword">finally</span>:</span><br><span
                                                class="line">        <span class="keyword">if</span> saved_locale <span
                                                class="keyword">is</span> <span class="keyword">not</span> <span
                                                class="keyword">None</span>:</span><br><span class="line">            translation.activate(saved_locale)</span><br><span
                                                class="line">    <span
                                                class="keyword">return</span> output</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <h3 id="runserver-command-的-handle"><a href="#runserver-command-的-handle" class="headerlink"
                                                                   title="runserver command 的 handle"></a>runserver
                                command
                                的 handle</h3>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br><span class="line">18</span><br><span
                                                class="line">19</span><br><span class="line">20</span><br><span
                                                class="line">21</span><br><span class="line">22</span><br><span
                                                class="line">23</span><br><span class="line">24</span><br><span
                                                class="line">25</span><br><span class="line">26</span><br><span
                                                class="line">27</span><br><span class="line">28</span><br><span
                                                class="line">29</span><br><span class="line">30</span><br><span
                                                class="line">31</span><br><span class="line">32</span><br><span
                                                class="line">33</span><br><span class="line">34</span><br><span
                                                class="line">35</span><br><span class="line">36</span><br><span
                                                class="line">37</span><br><span class="line">38</span><br><span
                                                class="line">39</span><br><span class="line">40</span><br><span
                                                class="line">41</span><br><span class="line">42</span><br><span
                                                class="line">43</span><br><span class="line">44</span><br><span
                                                class="line">45</span><br><span class="line">46</span><br><span
                                                class="line">47</span><br><span class="line">48</span><br><span
                                                class="line">49</span><br><span class="line">50</span><br><span
                                                class="line">51</span><br><span class="line">52</span><br><span
                                                class="line">53</span><br><span class="line">54</span><br><span
                                                class="line">55</span><br><span class="line">56</span><br><span
                                                class="line">57</span><br><span class="line">58</span><br><span
                                                class="line">59</span><br><span class="line">60</span><br><span
                                                class="line">61</span><br><span class="line">62</span><br><span
                                                class="line">63</span><br><span class="line">64</span><br><span
                                                class="line">65</span><br><span class="line">66</span><br><span
                                                class="line">67</span><br><span class="line">68</span><br><span
                                                class="line">69</span><br><span class="line">70</span><br><span
                                                class="line">71</span><br><span class="line">72</span><br><span
                                                class="line">73</span><br><span class="line">74</span><br><span
                                                class="line">75</span><br><span class="line">76</span><br><span
                                                class="line">77</span><br><span class="line">78</span><br><span
                                                class="line">79</span><br><span class="line">80</span><br><span
                                                class="line">81</span><br><span class="line">82</span><br><span
                                                class="line">83</span><br><span class="line">84</span><br><span
                                                class="line">85</span><br><span class="line">86</span><br><span
                                                class="line">87</span><br><span class="line">88</span><br><span
                                                class="line">89</span><br><span class="line">90</span><br><span
                                                class="line">91</span><br><span class="line">92</span><br><span
                                                class="line">93</span><br><span class="line">94</span><br><span
                                                class="line">95</span><br><span class="line">96</span><br><span
                                                class="line">97</span><br><span class="line">98</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">get_handler</span><span class="params">(self, *args, **options)</span>:</span></span><br><span
                                                class="line">     <span class="string">"""Return the default WSGI handler for the runner."""</span></span><br><span
                                                class="line">     <span class="keyword">return</span> get_internal_wsgi_application()</span><br><span
                                                class="line"></span><br><span class="line"> <span class="function"><span
                                                class="keyword">def</span> <span class="title">handle</span><span
                                                class="params">(self, *args, **options)</span>:</span></span><br><span
                                                class="line">     <span class="keyword">from</span> django.conf <span
                                                class="keyword">import</span> settings</span><br><span
                                                class="line"></span><br><span class="line">     <span
                                                class="keyword">if</span> <span class="keyword">not</span> settings.DEBUG <span
                                                class="keyword">and</span> <span class="keyword">not</span> settings.ALLOWED_HOSTS:</span><br><span
                                                class="line">         <span
                                                class="keyword">raise</span> CommandError(<span class="string">'You must set settings.ALLOWED_HOSTS if DEBUG is False.'</span>)</span><br><span
                                                class="line"></span><br><span class="line">     self.use_ipv6 = options[<span
                                                class="string">'use_ipv6'</span>]</span><br><span
                                                class="line">     <span class="keyword">if</span> self.use_ipv6 <span
                                                class="keyword">and</span> <span class="keyword">not</span> socket.has_ipv6:</span><br><span
                                                class="line">         <span
                                                class="keyword">raise</span> CommandError(<span class="string">'Your Python does not support IPv6.'</span>)</span><br><span
                                                class="line">     self._raw_ipv6 = <span
                                                class="keyword">False</span></span><br><span class="line">     <span
                                                class="keyword">if</span> <span class="keyword">not</span> options[<span
                                                class="string">'addrport'</span>]:</span><br><span class="line">         self.addr = <span
                                                class="string">''</span></span><br><span class="line">         self.port = self.default_port</span><br><span
                                                class="line">     <span class="keyword">else</span>:</span><br><span
                                                class="line">         m = re.match(naiveip_re, options[<span
                                                class="string">'addrport'</span>])</span><br><span class="line">         <span
                                                class="keyword">if</span> m <span class="keyword">is</span> <span
                                                class="keyword">None</span>:</span><br><span
                                                class="line">             <span class="keyword">raise</span> CommandError(<span
                                                class="string">'"%s" is not a valid port number '</span></span><br><span
                                                class="line">                                <span class="string">'or address:port pair.'</span> % options[<span
                                                class="string">'addrport'</span>])</span><br><span class="line">         self.addr, _ipv4, _ipv6, _fqdn, self.port = m.groups()</span><br><span
                                                class="line">         <span class="keyword">if</span> <span
                                                class="keyword">not</span> self.port.isdigit():</span><br><span
                                                class="line">             <span class="keyword">raise</span> CommandError(<span
                                                class="string">"%r is not a valid port number."</span> % self.port)</span><br><span
                                                class="line">         <span
                                                class="keyword">if</span> self.addr:</span><br><span class="line">             <span
                                                class="keyword">if</span> _ipv6:</span><br><span class="line">                 self.addr = self.addr[<span
                                                class="number">1</span>:<span class="number">-1</span>]</span><br><span
                                                class="line">                 self.use_ipv6 = <span
                                                class="keyword">True</span></span><br><span class="line">                 self._raw_ipv6 = <span
                                                class="keyword">True</span></span><br><span
                                                class="line">             <span class="keyword">elif</span> self.use_ipv6 <span
                                                class="keyword">and</span> <span
                                                class="keyword">not</span> _fqdn:</span><br><span class="line">                 <span
                                                class="keyword">raise</span> CommandError(<span class="string">'"%s" is not a valid IPv6 address.'</span> % self.addr)</span><br><span
                                                class="line">     <span class="keyword">if</span> <span class="keyword">not</span> self.addr:</span><br><span
                                                class="line">         self.addr = self.default_addr_ipv6 <span
                                                class="keyword">if</span> self.use_ipv6 <span
                                                class="keyword">else</span> self.default_addr</span><br><span
                                                class="line">         self._raw_ipv6 = self.use_ipv6</span><br><span
                                                class="line">     self.run(**options)</span><br><span
                                                class="line"></span><br><span class="line"> <span class="function"><span
                                                class="keyword">def</span> <span class="title">run</span><span
                                                class="params">(self, **options)</span>:</span></span><br><span
                                                class="line">     <span class="string">"""Run the server, using the autoreloader if needed."""</span></span><br><span
                                                class="line">     use_reloader = options[<span class="string">'use_reloader'</span>]</span><br><span
                                                class="line"></span><br><span class="line">     <span
                                                class="keyword">if</span> use_reloader:</span><br><span class="line">         autoreload.main(self.inner_run, <span
                                                class="keyword">None</span>, options)</span><br><span class="line">     <span
                                                class="keyword">else</span>:</span><br><span class="line">         self.inner_run(<span
                                                class="keyword">None</span>, **options)</span><br><span
                                                class="line"></span><br><span class="line"> <span class="function"><span
                                                class="keyword">def</span> <span class="title">inner_run</span><span
                                                class="params">(self, *args, **options)</span>:</span></span><br><span
                                                class="line">     <span class="comment"># If an exception was silenced in ManagementUtility.execute in order</span></span><br><span
                                                class="line">     <span class="comment"># to be raised in the child process, raise it now.</span></span><br><span
                                                class="line">     autoreload.raise_last_exception()</span><br><span
                                                class="line"></span><br><span
                                                class="line">     threading = options[<span class="string">'use_threading'</span>]</span><br><span
                                                class="line">     <span class="comment"># 'shutdown_message' is a stealth option.</span></span><br><span
                                                class="line">     shutdown_message = options.get(<span class="string">'shutdown_message'</span>, <span
                                                class="string">''</span>)</span><br><span class="line">     quit_command = <span
                                                class="string">'CTRL-BREAK'</span> <span class="keyword">if</span> sys.platform == <span
                                                class="string">'win32'</span> <span class="keyword">else</span> <span
                                                class="string">'CONTROL-C'</span></span><br><span
                                                class="line"></span><br><span class="line">     self.stdout.write(<span
                                                class="string">"Performing system checks...\n\n"</span>)</span><br><span
                                                class="line">     self.check(display_num_errors=<span class="keyword">True</span>)</span><br><span
                                                class="line">     <span class="comment"># Need to check migrations here, so can't use the</span></span><br><span
                                                class="line">     <span class="comment"># requires_migrations_check attribute.</span></span><br><span
                                                class="line">     self.check_migrations()</span><br><span class="line">     now = datetime.now().strftime(<span
                                                class="string">'%B %d, %Y - %X'</span>)</span><br><span class="line">     self.stdout.write(now)</span><br><span
                                                class="line">     self.stdout.write((</span><br><span class="line">         <span
                                                class="string">"Django version %(version)s, using settings %(settings)r\n"</span></span><br><span
                                                class="line">         <span class="string">"Starting development server at %(protocol)s://%(addr)s:%(port)s/\n"</span></span><br><span
                                                class="line">         <span class="string">"Quit the server with %(quit_command)s.\n"</span></span><br><span
                                                class="line">     ) % {</span><br><span class="line">         <span
                                                class="string">"version"</span>: self.get_version(),</span><br><span
                                                class="line">         <span class="string">"settings"</span>: settings.SETTINGS_MODULE,</span><br><span
                                                class="line">         <span class="string">"protocol"</span>: self.protocol,</span><br><span
                                                class="line">         <span class="string">"addr"</span>: <span
                                                class="string">'[%s]'</span> % self.addr <span class="keyword">if</span> self._raw_ipv6 <span
                                                class="keyword">else</span> self.addr,</span><br><span class="line">         <span
                                                class="string">"port"</span>: self.port,</span><br><span class="line">         <span
                                                class="string">"quit_command"</span>: quit_command,</span><br><span
                                                class="line">     })</span><br><span class="line"></span><br><span
                                                class="line">     <span class="keyword">try</span>:</span><br><span
                                                class="line">         handler = self.get_handler(*args, **options)</span><br><span
                                                class="line">         run(self.addr, int(self.port), handler,</span><br><span
                                                class="line">             ipv6=self.use_ipv6, threading=threading, server_cls=self.server_cls)</span><br><span
                                                class="line">     <span class="keyword">except</span> socket.error <span
                                                class="keyword">as</span> e:</span><br><span class="line">         <span
                                                class="comment"># Use helpful error messages instead of ugly tracebacks.</span></span><br><span
                                                class="line">         ERRORS = {</span><br><span class="line">             errno.EACCES: <span
                                                class="string">"You don't have permission to access that port."</span>,</span><br><span
                                                class="line">             errno.EADDRINUSE: <span class="string">"That port is already in use."</span>,</span><br><span
                                                class="line">             errno.EADDRNOTAVAIL: <span class="string">"That IP address can't be assigned to."</span>,</span><br><span
                                                class="line">         }</span><br><span class="line">         <span
                                                class="keyword">try</span>:</span><br><span class="line">             error_text = ERRORS[e.errno]</span><br><span
                                                class="line">         <span
                                                class="keyword">except</span> KeyError:</span><br><span class="line">             error_text = e</span><br><span
                                                class="line">         self.stderr.write(<span
                                                class="string">"Error: %s"</span> % error_text)</span><br><span
                                                class="line">         <span class="comment"># Need to use an OS exit because sys.exit doesn't work in a thread</span></span><br><span
                                                class="line">         os._exit(<span class="number">1</span>)</span><br><span
                                                class="line">     <span class="keyword">except</span> KeyboardInterrupt:</span><br><span
                                                class="line">         <span class="keyword">if</span> shutdown_message:</span><br><span
                                                class="line">             self.stdout.write(shutdown_message)</span><br><span
                                                class="line">         sys.exit(<span class="number">0</span>)</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p>一层套一层，最终调用了下面这个方法</p>
                            <h3 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h3>
                            <p>层层深入发现， runserver方法最后调用了以下函数</p>
                            <figure class="highlight python">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                                class="line">3</span><br><span class="line">4</span><br><span
                                                class="line">5</span><br><span class="line">6</span><br><span
                                                class="line">7</span><br><span class="line">8</span><br><span
                                                class="line">9</span><br><span class="line">10</span><br><span
                                                class="line">11</span><br><span class="line">12</span><br><span
                                                class="line">13</span><br><span class="line">14</span><br><span
                                                class="line">15</span><br><span class="line">16</span><br><span
                                                class="line">17</span><br></pre>
                                        </td>
                                        <td class="code">
                                        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span
                                                class="title">run</span><span class="params">(addr, port, wsgi_handler, ipv6=False, threading=False, server_cls=WSGIServer)</span>:</span></span><br><span
                                                class="line">    server_address = (addr, port)</span><br><span
                                                class="line">    <span
                                                class="keyword">if</span> threading:</span><br><span class="line">        httpd_cls = type(<span
                                                class="string">'WSGIServer'</span>, (socketserver.ThreadingMixIn, server_cls), {})</span><br><span
                                                class="line">    <span class="keyword">else</span>:</span><br><span
                                                class="line">        httpd_cls = server_cls</span><br><span
                                                class="line">    httpd = httpd_cls(server_address, WSGIRequestHandler, ipv6=ipv6)</span><br><span
                                                class="line">    <span
                                                class="keyword">if</span> threading:</span><br><span class="line">        <span
                                                class="comment"># ThreadingMixIn.daemon_threads indicates how threads will behave on an</span></span><br><span
                                                class="line">        <span class="comment"># abrupt shutdown; like quitting the server by the user or restarting</span></span><br><span
                                                class="line">        <span class="comment"># by the auto-reloader. True means the server will not wait for thread</span></span><br><span
                                                class="line">        <span class="comment"># termination before it quits. This will make auto-reloader faster</span></span><br><span
                                                class="line">        <span class="comment"># and will prevent the need to kill the server manually if a thread</span></span><br><span
                                                class="line">        <span class="comment"># isn't terminating correctly.</span></span><br><span
                                                class="line">        httpd.daemon_threads = <span
                                                class="keyword">True</span></span><br><span class="line">    httpd.set_app(wsgi_handler)</span><br><span
                                                class="line">    httpd.serve_forever()</span><br></pre>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </figure>
                            <p>也就是我们平时开发最常使用的单线程服务器（注意这个单线程， 这导致了内置的内存缓存本地生效生产环境不生效的问题， 因为生产环境是多线程的- -）</p>
                            <h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3>
                            <p>好啦今天的分享就到这了， 再分享一句昨天看到的很不错的话。</p>
                            <blockquote>
                                <p>
                                    “完美主义是压迫者的声音，是人们的敌人。它会束缚你的想法，毁掉你的生命，同时它也会妨碍你创建较差的草稿初案。我认为完美主义基于一种强迫性的想法：如果你足够细致，每件事情都做得很好，那你就不会失败。但事实是，无论怎么做你都有可能会失败，可是很多人即使不太仔细也会做得比你好，而且其间也会拥有更多欢乐。”</p>
                            </blockquote>
                            <p>不要追求完美主义， 那是跟自己故意不去， 一点点的进去， 不断的大胆尝试， 错误， 改正， 重复这一切， 这才是最适合我们程序员的学习方式。 共勉!</p>
                            <p><a href="https://www.fabiaoqing.com/uploads/1521035641-1574.gif"
                                  class="fancybox fancybox.image" rel="group"><img
                                    src="https://www.fabiaoqing.com/uploads/1521035641-1574.gif" alt="ojbk"></a></p>
                        </div>
                        <footer class="post-footer">
                            <div class="post-tags">
                                <a href="/tags/django/" rel="tag"># django</a>
                            </div>
                            <div class="post-nav">
                                <div class="post-nav-next post-nav-item">
                                    <a href="/2018/07/06/django-choice-enum/" rel="next"
                                       title="django models choices的三种实现方式">
                                        <i class="fa fa-chevron-left"></i> django models choices的三种实现方式
                                    </a>
                                </div>
                                <span class="post-nav-divider"></span>
                                <div class="post-nav-prev post-nav-item">
                                </div>
                            </div>
                        </footer>
                    </div>
                </article>
                <div class="post-spread">
                </div>
            </div>
        </div>
        <div class="comments" id="comments" style="opacity: 1; display: block;">
            <div id="lv-container" data-id="city" data-uid="MTAyMC8zNzg1NC8xNDM4NA==">
                <iframe src="https://was.livere.me/get-uuid" title="livere-uuid" id="livere-uuid"
                        style="display: none;"></iframe>
                <iframe title="livere" scrolling="no" frameborder="0"
                        src="https://was.livere.me/comment/city?id=city&amp;refer=cluas.me%2F2018%2F07%2F07%2Fwhat-happen-when-django-runserver%2F&amp;uid=MTAyMC8zNzg1NC8xNDM4NA%3D%3D&amp;site=http%3A%2F%2Fyoursite.com%2F2018%2F07%2F07%2Fwhat-happen-when-django-runserver%2Findex.html&amp;title=python%20manage.py%20runserver%20%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F&amp;logo=https%3A%2F%2Fwww.fabiaoqing.com%2Fuploads%2F1521035641-1574.gif"
                        id="lv-comment-971"
                        style="min-width: 100%; width: 100px; height: 356px; overflow: hidden; border: 0px; z-index: 124212;"></iframe>
            </div>
        </div>
    </div>
</div>
</body>
</html>